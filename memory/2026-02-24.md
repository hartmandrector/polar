# 2026-02-24 — Gamepad Controls & Brake Flap Fixes

## Commits
- `a1248d8` (sim branch) — Fix canopy gamepad: invert brakes, invert risers, render brake flaps
  - Swapped LT/RT triggers, then REVERTED swap (LT=left, RT=right is correct)
  - Inverted stick Y for risers: back=fronts, forward=rears (confirmed correct by Hartman)
  - Pass gamepad brake values through FlightState (`canopyControlMode: 'brakes'`, `canopyLeftHand`/`canopyRightHand`) so viewer renders brake flap segments

## Brake Flap Fixes (uncommitted, in progress)
- **CP offset bug found & fixed**: Brake flaps returned Kirchhoff `cp` value to renderer, which applied a SECOND position offset on top of the internal `cpShift`. At high flap α, cp > 0.25 created large aft offset pushing arrows off the back of the canopy. Fix: return `cp: 0.25` from brake flap getCoeffs so renderer adds zero offset (position already managed by cpShift).
- **CP shift magnitude increased**: Changed from `0.25 * flapChord / refLen` to `0.25 * parentCellChord / refLen` — full quarter-chord travel at max brake. Hartman confirmed direction is correct but magnitude still looks small (suspects intrinsic scaling factor).
- **Debug logging active**: `flap_r1` and `flap_l1` print position data to console when brake > 0.01.

## Open Issues (brake flaps)
- **Left brake flaps might not be triggering** — need to verify flap_l1 console output
- **Brake-to-cell coupling direction**: Hartman reports brakes appear to have negative AOA effect on parent cells (should be positive). Code shows `deltaAlphaBrake = brakeInput * brakeSensitivity * BRAKE_ALPHA_COUPLING_DEG(2.5)` added to alpha — positive direction. Possible causes: (1) already near stall so +α reduces lift via Kirchhoff, (2) flap drag dominates cell lift increase. Needs further investigation.
- **Double chordScale/spanScale**: Both cell and flap getCoeffs apply deploy scaling to `this.position`, AND the renderer (vectors.ts lines 374-378) applies it again. Consistent for both so not visually broken at full deploy, but technically double-scaled during deployment transitions.

## Key Findings
- Real-time sim debugging with gamepad is very productive — Hartman tested changes as they were made via hot reload
- NED math for flap positions is correct (+x = toward nose, cpShift positive = toward nose)
- `nedToThreeJS`: Three.js z = NED x, so forward motion in NED maps to forward in Three.js correctly
- `getPositionMeters()` (physics) correctly includes chordScale; `getCoeffs()` sets `this.position` (rendering) — these are separate code paths
