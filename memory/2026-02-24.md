# 2026-02-24 — Gamepad Controls & Brake Flap Fixes

## Commits
- `a1248d8` (sim branch) — Fix canopy gamepad: invert brakes, invert risers, render brake flaps
  - Swapped LT/RT triggers, then REVERTED swap (LT=left, RT=right is correct)
  - Inverted stick Y for risers: back=fronts, forward=rears (confirmed correct by Hartman)
  - Pass gamepad brake values through FlightState (`canopyControlMode: 'brakes'`, `canopyLeftHand`/`canopyRightHand`) so viewer renders brake flap segments

## Brake Flap Fixes (uncommitted, in progress)
- **CP offset bug found & fixed**: Brake flaps returned Kirchhoff `cp` value to renderer, which applied a SECOND position offset on top of the internal `cpShift`. At high flap α, cp > 0.25 created large aft offset pushing arrows off the back of the canopy. Fix: return `cp: 0.25` from brake flap getCoeffs so renderer adds zero offset (position already managed by cpShift).
- **CP shift magnitude increased**: Changed from `0.25 * flapChord / refLen` to `0.25 * parentCellChord / refLen` — full quarter-chord travel at max brake. Hartman confirmed direction is correct but magnitude still looks small (suspects intrinsic scaling factor).
- **Debug logging active**: `flap_r1` and `flap_l1` print position data to console when brake > 0.01.

## Open Issues (brake flaps)
- **Left brake flaps might not be triggering** — need to verify flap_l1 console output
- **Brake-to-cell coupling direction**: Hartman reports brakes appear to have negative AOA effect on parent cells (should be positive). Code shows `deltaAlphaBrake = brakeInput * brakeSensitivity * BRAKE_ALPHA_COUPLING_DEG(2.5)` added to alpha — positive direction. Possible causes: (1) already near stall so +α reduces lift via Kirchhoff, (2) flap drag dominates cell lift increase. Needs further investigation.
- **Double chordScale/spanScale**: Both cell and flap getCoeffs apply deploy scaling to `this.position`, AND the renderer (vectors.ts lines 374-378) applies it again. Consistent for both so not visually broken at full deploy, but technically double-scaled during deployment transitions.

## Key Findings
- Real-time sim debugging with gamepad is very productive — Hartman tested changes as they were made via hot reload
- NED math for flap positions is correct (+x = toward nose, cpShift positive = toward nose)
- `nedToThreeJS`: Three.js z = NED x, so forward motion in NED maps to forward in Three.js correctly
- `getPositionMeters()` (physics) correctly includes chordScale; `getCoeffs()` sets `this.position` (rendering) — these are separate code paths

## Brake Control Inversion — Root Cause Found (afternoon session)
- **Debug confirmed**: Left brake wiring is correct (cell_l1 gets brakeInput). Risers were SWAPPED — pulling back on left stick (rear riser) showed `frontR=0.60, rearR=0.00`. The original axis mapping (forward=front, back=rear) was correct; the earlier "inversion fix" broke it.
- **Fix**: Restored original riser mapping in `readCanopyGamepad()`: `frontRiserLeft = max(0, -leftY)` (forward), `rearRiserLeft = max(0, leftY)` (back). Removed all debug logging (was causing perf issues).
- **Commit `b0f554f`** (sim branch, pushed): "Fix brake flap CP rendering + restore correct riser axis mapping" — CP offset bug fix, riser axis restore, debug log cleanup.
- **Lesson**: The original gamepad axes were correct for front/rear — only left/right sides were crossed somewhere. Uncrossing one swap at a time.

## FlySight 2 Firmware & Companion Projects
- **Location**: `/mnt/c/dev/flysight firmware/hozaka/`
  - `flysight-2-firmware/` — STM32WB5M embedded C, forked from Hozaka → Hartman's GitHub (`hartmandrector/flysight-2-firmware`), `develop` branch
  - `FlySight-Companion/FlySight-Companion/` — Android app (Kotlin/Compose/Dagger2), Hozaka's project
- **Firmware work (Hartman's)**: BLE sensor streaming (accel, gyro, mag, baro, humidity), AHRS sensor fusion (x-io Fusion library), mag calibration via BLE, configurable decimation. 13K+ lines C in `FlySight/`. Version tag: `v2025.10.08.develop`.
- **Companion app**: 360 Kotlin files, 6 feature modules (FSDevice, ConfigFiles, Firmware, Records, Session, UserPreferences), 6 middleware (Bluetooth, Audio, Network, USB, Location, ExternalDisplay). Supports BLE pairing, file transfer, OTA firmware updates, live GNSS HUD, FlyBlind audio mode.
- **Hartman's devices**: Production FlySight 2 (full bootloader, OTA capable) + new dev device (SWD/serial debug, no bootloader, faster prototyping). Currently integrating additional sensor BLE streams beyond GPS.
- **Dev folder structure**: `/mnt/c/dev/` contains `polar`, `hartman-ops`, `flysight firmware/hozaka/`, `CloudBASE`, `kalman`, `kalman-viz`, `sustained`, `wavelets`, and others.
- **Pipeline**: FlySight hardware → firmware (sensor fusion + BLE) → Companion app (config/test) → Kalman filter → Polar Project (aero models)
- **Note**: Hozaka (HozakaN on GitHub) is the FlySight Companion author and firmware fork maintainer. Hartman forked from Hozaka's develop branch.
